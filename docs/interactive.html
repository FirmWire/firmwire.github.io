<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Interactive exploration - FirmWire</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">FirmWire</a></li><li class="chapter-item expanded "><a href="installation.html"><strong aria-hidden="true">1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="quick_start.html"><strong aria-hidden="true">2.</strong> Quick Start</a></li><li class="chapter-item expanded "><a href="background.html"><strong aria-hidden="true">3.</strong> Background</a></li><li class="chapter-item expanded "><a href="cli_reference.html"><strong aria-hidden="true">4.</strong> CLI Reference</a></li><li class="chapter-item expanded "><a href="workspaces.html"><strong aria-hidden="true">5.</strong> Workspaces</a></li><li class="chapter-item expanded "><a href="pattern_db.html"><strong aria-hidden="true">6.</strong> PatternDB</a></li><li class="chapter-item expanded "><a href="modkit.html"><strong aria-hidden="true">7.</strong> Baseband ModKit</a></li><li class="chapter-item expanded "><a href="interactive.html" class="active"><strong aria-hidden="true">8.</strong> Interactive exploration</a></li><li class="chapter-item expanded "><a href="fuzzing.html"><strong aria-hidden="true">9.</strong> Fuzzing</a></li><li class="chapter-item expanded "><a href="trophy_wall.html"><strong aria-hidden="true">10.</strong> Trophy Wall</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">FirmWire</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/FirmWire/FirmWire/" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="interactive-exploration"><a class="header" href="#interactive-exploration">Interactive Exploration</a></h1>
<p>FirmWire has multiple ways to facilitate interactive exploration of the emulated baseband firmware.
The reason for such exploration are various, ranging from aiding static reverse engineering over observing the baseband's behavior when receiving custom messages to root-cause analysis for crashing inputs.</p>
<h2 id="gdb"><a class="header" href="#gdb">GDB</a></h2>
<p>The most classic way to interact with the emulated baseband is via GDB.
Simply start FirmWire with the <code>-s/--gdb-server</code> flag while specifying a port number to start a gdb server!
Then, you can start up your local gdb build (we recommend <code>gdb-multiarch</code> for Ubuntu 20.04) and connect to the emulated baseband by executing from within gdb:</p>
<pre><code>target remote :PORT
</code></pre>
<p>Alternatively, when using gdb together with <a href="https://gef.readthedocs.io/">gef</a>, we suggest to run the following for better usability instead:</p>
<pre><code>gef-remote --qemu-mode 127.0.0.1:PORT
</code></pre>
<p>Once connected, you should be able to set breakpoints, inspect and modify memory, as well as steering execution just as usual.
Under the hood, FirmWire spawns a gdb server provided by the corresponding <a href="https://github.com/avatartwo/avatar2/blob/main/avatar2/plugins/gdbserver.py">avatar2 plugin</a>. This allows to transparently access both the memory provided by avatar-backed memory ranges (as in the case of  python peripherals), and emulated memory provided by PANDA.</p>
<blockquote>
<p><strong>NOTE:</strong> For ARM targets (Shannon), due to mixed ARM / Thumb2, you <em>may</em> need to set breakpoints at your target addresses +/- 1 byte. This is a limitation of QEMU's ARM gdbstub, causing breakpoints to be missed depending on the code's ISA mode.</p>
</blockquote>
<p>What's more, via gdb's <code>monitor</code> command you have directly access to the Python context of avatar2 gdb server, and allows you to execute simple Python statements. You even can access the global avatar object from gdb by executing:</p>
<pre><code>monitor self.avatar
</code></pre>
<p>However, if you are really eager to control FirmWire's, and the emulated baseband's, execution state from Python, we recommend using IPython as described below.</p>
<h2 id="console"><a class="header" href="#console">Console</a></h2>
<p>FirmWire offers a second convenient way for controlling execution: a IPython/jupyter console interface. To invoke it, run FirmWire with the <code>--console</code> flag:</p>
<pre><code>$ python3 firmwire.py modem.bin --console
</code></pre>
<p>Then, after initial FirmWire startup, you can connect to the console from the second terminal:</p>
<pre><code>$ jupyter-console --existing
</code></pre>
<p>In here, you have full access to FirmWire's API, and your main interface to interact with the emulated baseband is its <code>machine</code> abstraction, which is directly accessible via <code>self</code>.</p>
<p>While explaining the full API and available functions would be to extensive for this guide, below are the most important objects and methods provided by firmwire's machine object.</p>
<div class="table-wrapper"><table><thead><tr><th>Object</th><th>Description</th></tr></thead><tbody>
<tr><td><code>self.avatar</code></td><td>The avatar object, providing information about memory ranges and python peripherals</td></tr>
<tr><td><code>self.loader</code></td><td>The vendor specific loader, providing information about the loaded firmware image.</td></tr>
<tr><td><code>self.loader.symbol_table</code></td><td>The symbols extracted by the loader, using <a href="pattern_db.html">patternDB</a> and auxiliary information.</td></tr>
<tr><td><code>self.modkit</code></td><td>Handle to FirmWire's <a href="modkit.html">modkit</a></td></tr>
<tr><td><code>self.panda</code></td><td>Handle to libpanda, the PANDA library with python bindings</td></tr>
<tr><td><code>self.qemu</code></td><td>Direct handle to avatar's PyPanda target, the avatar wrapper around libpanda. Follows avatar2's target API.</td></tr>
</tbody></table>
</div>
<p>To steer execution and inspecting memory, the <code>self.qemu</code> object will most likely be your bread and butter.
It provides functions such as <code>cont()</code>, <code>stop()</code>, <code>set_breakpoint()</code>, <code>read_memory()</code> or <code>write_memory()</code> - more information can be found over in handbook for <a href="">avatar2</a>.</p>
<p>Besides these objects and capabilities provided by the PANDA and avatar2 frameworks, the FirmWire also provide a couple of additional methods to make exploration easier:</p>
<div class="table-wrapper"><table><thead><tr><th>Method/Signature</th><th>Description</th></tr></thead><tbody>
<tr><td><code>self.get_tasks()</code></td><td>Retrieves the RTOS tasks automatically identified by FirmWire in its abstract Python representation.</td></tr>
<tr><td><code>self.get_peripheral(name)</code></td><td>Retrieve a handle to the Python peripheral with specified name.</td></tr>
<tr><td><code>self.restore_snapshot(snapshot_name)</code></td><td>Restores <a href="workspaces.html">Snapshot</a> with given name.</td></tr>
<tr><td><code>self.run_for(t)</code></td><td>If the machine is stopped, continue execution for <code>t</code> seconds.</td></tr>
<tr><td><code>self.snapshot(snapshot_name)</code></td><td>Create snapshot of current execution state with given name.</td></tr>
<tr><td><code>self.set_breakpoint(address, handler)</code></td><td>Set a breakpoint at specified address and execute the code provided in <code>handler</code> when hit.</td></tr>
</tbody></table>
</div>
<p>For Shannon basebands, the interactive capabilities are further extended by the special GuestLink peripheral.</p>
<h2 id="guestlink-shannon-only"><a class="header" href="#guestlink-shannon-only">GuestLink (Shannon only)</a></h2>
<p>The GuestLink is a combination of custom task injected into the baseband and python peripheral, allowing for <em>interaction</em> with the emulated baseband. To make use of it, start FirmWire both with activated console and injected <code>glink</code> task:</p>
<pre><code>./firmwire.py -t glink --console ./modem.bin
</code></pre>
<p>Now, after connecting to the console as described above, you can get a handle to the glink peripheral:</p>
<pre><code>In [1]: gl = self.get_peripheral('glink')
</code></pre>
<p>This GLink peripheral can be controlled from Python and uses a MMIO range to communicated with the GLink task.
More specifically, the MMIO range is organized as follows:</p>
<pre><code class="language-C">struct glink_peripheral {
  uint32_t access;
  uint32_t tx_head;
  uint32_t tx_tail;
  uint32_t rx_head;
  uint32_t rx_tail;
  uint8_t tx_fifo[TX_FIFO_SIZE];
  uint8_t rx_fifo[RX_FIFO_SIZE];
} ;
</code></pre>
<p>The <code>access</code> field is used to communicate return values from the GLink task back to the Python peripheral, while the rest are data structures for input and output FIFO buffers.
These buffers use a simple packet-based data format for communication:</p>
<pre><code class="language-C">struct glink_cmd_header {
  uint8_t cmd;
  uint8_t len;
  // next field is variable amount of octets
};
</code></pre>
<p>Currently, GuestLinks implementation only allows for commands from Python to the emulated baseband. The available commands are:</p>
<div class="table-wrapper"><table><thead><tr><th>CMD</th><th>PythonAPI</th><th>Description</th></tr></thead><tbody>
<tr><td>GLINK_SEND_QUEUE_INDIR</td><td><code>gl.send_queue(True, src_qid_name, dst_qid_name, msg_group, payload)</code></td><td>Sends specified message to baseband internal queue. Payload is provided as allocated memory chunk, to be free'd by the baseband.</td></tr>
<tr><td>GLINK_SEND_QUEUE</td><td><code>gl.send_queue(False, src_qid_name, dst_qid_name, msg_group, payload)</code></td><td>Sends specified message to baseband internal queue. Payload is inlined with the msg_struct.</td></tr>
<tr><td>GLINK_SET_EVENT</td><td><code>gl.set_event(event)</code></td><td>Sets the baseband internal event. <code>event</code> can either be int (event number) or bytes (event name).</td></tr>
<tr><td>GLINK_ALLOC_BLOCK</td><td><code>gl.create_block(size)</code></td><td>Allocate a chunk of memory of given <code>size</code>. The address of the chunk can later be retrieved via <code>gl.access</code>.</td></tr>
<tr><td>GLINK_CALL_FUNC</td><td><code>gl.call_function(fn, args)</code></td><td>Call function <code>fn</code> with args specified in <code>args</code>. <code>fn</code> must be of type int, and <code>args</code> a list of <code>ints</code>. The return code of the function can later be retrieved from <code>gl.access</code>.</td></tr>
</tbody></table>
</div>
<h2 id="interactive-exploration-tips--tricks"><a class="header" href="#interactive-exploration-tips--tricks">Interactive exploration: Tips &amp; Tricks</a></h2>
<h4 id="stopping-execution-on-startup"><a class="header" href="#stopping-execution-on-startup">Stopping execution on startup</a></h4>
<p>FirmWire supports to stop after initialization. This means, you can interactively step through the full boot process, or control execution in a fine-grained manner after restoring a snapshot. All you need to do is to supply the <code>-S/--stop</code> flag to FirmWire on the command line.</p>
<h4 id="guestlink-asynchronous-behavior"><a class="header" href="#guestlink-asynchronous-behavior">GuestLink: Asynchronous behavior:</a></h4>
<p>When using GuestLink, keep in mind that GLink acts fully asynchronously, i.e., when calling a function from Python, the according command is only written to the shared MMIO region. The GLink task in the baseband then has to parse and process the command before the result is available.</p>
<p>For better understanding, we provide a typical guestlink usage example below, allocating a block of size 0x100, and storing the result into chunk_addr:</p>
<pre><code class="language-Python">In [1]: self.qemu.stop()
In [2]: gl = self.get_peripheral('glink')
In [3]: gl.create_block(0x100)
In [4]: self.run_for(0.5)
In [5]: chunk_addr = gl.access
In [6]: hex(chunk_addr)
Out[6]: '0x44f0293c'
</code></pre>
<h4 id="guestlink--snapshots"><a class="header" href="#guestlink--snapshots">GuestLink &amp; Snapshots:</a></h4>
<p>When using GLink in combination with snapshots, it is important to note that a reference to the guest link peripheral does not propagate across snapshots. That means, after restoring a snapshot, a new reference to the GLink peripheral has to be required via <code>get_peripheral</code>, as shown below:</p>
<pre><code class="language-Python">In [1]: gl = self.get_peripheral('glink')
In [2]: gl
Out[2]: &lt;firmwire.hw.glink.GLinkPeripheral at 0x7f720c4f59d0&gt;
In [3]: self.restore_snapshot(&quot;glink_demo&quot;)
In [3]: gl = self.get_peripheral('glink')
In [4]: gl 
Out[4]: &lt;firmwire.hw.glink.GLinkPeripheral at 0x7f7219792850&gt;`
</code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="modkit.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="fuzzing.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="modkit.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="fuzzing.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
